<!DOCTYPE html>  
<head> 
    <title>电影拍摄地点搜索</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<<script src="https://unpkg.com/jquery@3.3.1/dist/jquery.js"></script>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"> </script>


<link rel="stylesheet" href="css/leaflet-search.min.css" />



<link rel="icon" type="image/png" href="//cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/images/spritesheet-2x.png">
<link rel="icon" type="image/png" href="//cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/images/spritesheet.png">
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.js"></script>

<link rel="stylesheet" type="text/css" href="./css/ControlMiniMap/Control.MiniMap.css" />
<link rel="stylesheet" type="text/css" href="./css/worstnightmare.css" />
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.Default.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/MarkerCluster.css" />
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.2.3/leaflet.draw.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"  />
<link rel="stylesheet" href="./css/leaflet-gps.css" />

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/0.4.0/leaflet.markercluster.js"></script>
<script type="text/javascript" src="./js/leaflet.markercluster.js"></script>
<script type="text/javascript" src="./js/leaflet-layerjson.min.js"></script>
<script type="text/javascript" src="./js/Leaflet.Sync/L.Map.Sync.js"></script>
<script type="text/javascript" src="./js/map_api.js"></script>
<script type="text/javascript" src="./js/worstnightmare.js"></script>
<script type="text/javascript" src="./js/leaflet.hash/leaflet-hash.js"></script>
<script type="text/javascript" src="./js/leaflet.search/leaflet-search.min.js"></script>
<script type="text/javascript" src="./js/ControlMiniMap/Control.MiniMap.js"></script>
<script type="text/javascript" src="./js/jquery.simplyCountable.js"></script>
<script type="text/javascript" src="./js/leaflet-gps.js"></script>


<link rel="stylesheet" href="css/zerogrid.css">
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/menu.css">
<link rel="stylesheet" href="css/all.min.css">
<link href="owl-carousel/owl.carousel.css" rel="stylesheet">

<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>


<style>
  body {
      margin: 0;
      padding: 0;
    }

	#mapAdd{
        border-radius: 0.125em;
    border: 2px solid #1978cf;
    margin: 4px 0;
    float: left;
    width: 800px;
    height: 800px;
    overflow: hidden;
    }
	
	#findbox {
	
	border-radius:.125em;
	
		
	margin-bottom: 10px;
	padding: 2px 2px;
	width: 40pm;
	height: 2.6em;
}

 .leaflet-control-search .search-cancel {
	position: static;
	float: left;
	margin-left: -22px;
}
 .leaflet-control-search .search-input{

	font-size: 1em;
	width: 12em;
	max-width: 100%;
	border: 2.5px solid #666;
	border-radius: 5px;
	margin: auto;
	position: relative;
	padding: 3px 20px 3px 2px;
	height:20px;

	
}

#mapAdd .leaflet-draw-edit-edit {
        display: none;
      }
 #mapAdd .leaflet-popup-content {
        width: 500px;
      }
	  .btn {
 
  
    font-weight: 400;
    text-align: center;
    vertical-align: middle;
    cursor: pointer;

    border: 1px solid transparent;
    white-space: nowrap;
   
    font-size: 14px;
    line-height: 1.42857143;
    border-radius: 4px;}
  </style>

</head>

<body>

  <body>
    <div class="wrap-body">
  
      <!--////////////////////////////////////Header-->
      <header>
        <div class="wrap-header">
          <!--Top-->
          <div id="top">
            <div class="zerogrid">
              <div class="row">
                <div class="col-1-3">
                  <span>From the big screen to real life.
                  </span>
                </div>
                <div class="col-2-3">
                  <ul class="list-inline top-link link">
            
                    <li><i class="fas fa-user-circle fa-lg fa-icon"></i><a href="account.html">Account </a></li>
                    <li><a href="#">FAQ</a></li>
                    
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <!---Main Header--->
          <div class="main-header">
            <div class="zerogrid">
              <div class="row">
                <div class="hero-heading">
  
                  <span>Reel Travel</span>
                  <div class="tl"></div>
                  <div class="tr"></div>
                  <div class="br"></div>
                  <div class="bl"></div>
                </div>
              </div>
            </div>
          </div>
  
          <!---Top Menu--->
          <div id="cssmenu">
            <ul>
              <li class="active"><a href="index.html"><span>Home Page</span></a></li>
              <li class="catalogue-page"><a href="catalogue.html"><span>Map</span></a>
                <ul>
                  <li class="movieinfo"><a href="movie.html"><span>by movie</span></a>
                    <!-- <ul>
                        <li><a href="#"><span>Sub Item</span></a></li>
                        <li class="last"><a href="#"><span>Sub Item</span></a></li>
                       </ul> -->
                  </li>
                  <li class="location"><a href="location.html"><span>by location</span></a>
                    <!-- <ul>
                        <li><a href="#"><span>Sub Item</span></a></li>
                        <li class="last"><a href="#"><span>Sub Item</span></a></li>
                       </ul> -->
                  </li>
                </ul>
              </li>
              <li><a href="archive.html"><span>Search Movie</span></a></li>
              <li><a href="test.html"><span>Your Footprints</span></a></li>
          
            </ul>
          </div>
  
        </div>
      </header>
  
  
  
      <!--////////////////////////////////////Container-->
      <section id="container">
	<div id="mapAdd" class="map" ></div>
	<div id="osm-fullscreen" class="note" style="float: left;">
      
      </div>

      </section>
 
	
 

    <script>
     


    var geoJsonData = getJsonData();
    var map_id = geoJsonData['id'];
	var position = getPositionFromHash();
    var zoom = position[0];
    var center_lon = position[1];
    var center_lat = position[2];

    var center = [center_lat, center_lon];
    var targetIcon = new L.icon({
        iconUrl: './images/target_32x32.png',
        iconSize:     [32, 32],
        shadowSize:   [50, 64],
        iconAnchor:   [12, 41],
        shadowAnchor: [4, 62],
        popupAnchor:  [3, -33]
    });

    var center_tiles = getTileURL(center[0], center[1], zoom);

    var markers = L.markerClusterGroup();

    var geoJsonLayer = L.geoJson(geoJsonData, {
        onEachFeature: function (feature, layer) {
            markers.addLayer(layer);
            layer.bindPopup(feature.properties.text);
        }
    });
	

    var drawControl = new L.Control.Draw({
        draw: {
            position: 'topleft',
            polygon : false,
            polyline : false,
            rectangle : false,
            circle : false
        },
        edit: {
            featureGroup: markers
        }
    });


	//create map for user to add their own location
	var osmclassic_url = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png';
	var osmclassic_attribution = 'Map data &copy; <a href="http://osm.org/copyright">' +
    'OpenStreetMap</a> contributors, Imagery &copy; OpenStreetMap';
	var osm_classic = L.tileLayer(osmclassic_url, {
        attribution: osmclassic_attribution,
        zoomMin: 2,
        zoomMax: 18
    });
	var baseLayers = {
        "OSM oggi": osm_classic,
    };

	var mapAdd = L.map('mapAdd', {
        layers: [osm_classic],
        center: center,
        zoom: zoom
    });
	mapAdd.addControl(drawControl);

	// minimappa
    var osm_minimap = new L.TileLayer(osmclassic_url, {
        minZoom: 0,
        maxZoom: 13
    });
    var miniMap = new L.Control.MiniMap(osm_minimap, {
        toggleDisplay: true
    }).addTo(mapAdd);

    // hash
    var hash = new L.Hash(mapAdd);




   /*
    * Draw events on map1:
    * * draw:created is fired on node creation
    * * draw:deleted is fired on node deletion (when saving)
    */

    mapAdd.on('draw:created', function (e) {
        console.log('draw:created');

        var type = e.layerType,
            layer = e.layer;

        // drawnItems.addLayer(layer);
        markers.addLayer(layer);

        var lat = layer._latlng.lat;
        var lon = layer._latlng.lng;
        var id = layer._leaflet_id;


        function saveIt(tweettext) {
            insertItem(lat, lon, map_id, id, tweettext);
            layer.closePopup();
            layer.bindPopup(tweettext);

        }
        
        if (type === 'marker') {
          var form = '<form id="inputform" enctype="multipart/form-data">' +
              '<h4>footprint 1</h4>' +
              '<textarea class="form-control" placeholder="Il tuo tweet" id="tweet-text" name="tweet-text" style="font-size: small;" row=5>' +
                "film information and my travel #OpenStreetMap!" +
              '</textarea>' +
              '<div class="row-fluid" style="text-align: right;">' +
                'caratteri: <span id="counter"></span>' +
              '</div>' +
              '<div class="row-fluid">' +
                  '<a role="button" class="btn save-button" id="save" title="save your footprint"></a>' +
                  '<a role="button" class="btn tweet-button" id="tweet"' +
                      'href="https://twitter.com/intent/tweet?via=OpenStreeMapIt&text=L%27agenzia%20delle%20entrate%20copia%20da%20OpenStreetMap!" ' +
                      'title="Save inserted and twittered point!"></a>' +
              '</div>' +
              '</form>';

          layer.bindPopup(form).openPopup();

          $('#tweet').simplyCountable({
            maxCount: 97,
          });
        }

        $('#save').click(function() {
            var tweettext = $('textarea#tweet-text').val();
            saveIt(tweettext);
        });

        $('#tweet').click(function tweetIt(event) {
            event.preventDefault();
            var tweettext = $('textarea#tweet-text').val();
            var twitterBaselink = "https://twitter.com/intent/tweet?";
            var params = {
                url: window.location.href,
                via: 'OpenStreetMapIt',
                text: tweettext
            };

            $('#tweet').attr('href', twitterBaselink + $.param(params));
            saveIt(tweettext);
        });

    });
   
    mapAdd.on('draw:deleted', function (e) {
        for ( var key in e.layers._layers ){
          var deleted_item = JSON.stringify(e.layers._layers[key].feature);
          deleteItem(deleted_item, map_id);
        }
    });

    mapAdd.addLayer(markers);
//定位当前位置
	
var gps = new L.Control.Gps({
		//autoActive:true,
		autoCenter:true
	});//inizialize control

	gps
	.on('gps:located', function(e) {
		//	e.marker.bindPopup(e.latlng.toString()).openPopup()
		console.log(e.latlng, map.getCenter())
	})
	.on('gps:disabled', function(e) {
		e.marker.closePopup()
	});

	gps.addTo(mapAdd);
    async function searchNominatim(query) {
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`, {
      headers: {
        Accept: 'application/json',
      },
    });
    const data = await response.json();
    return data.map((item) => ({
      display_name: String(item.display_name),
      lat: parseFloat(item.lat),
      lon: parseFloat(item.lon),
    }));
  } catch (error) {
    console.error(error);
  }
}


// 添加新的搜索方法，将 Nominatim 结果与样本数据一起返回
async function searchLocations(text, callResponse) {
  const nominatimResults = await searchNominatim(text);
  const sampleDataResults = data.filter((item) => item.title.toLowerCase().includes(text.toLowerCase()));

  const combinedResults = [
    ...nominatimResults.map((result) => ({
      display_name: result.display_name,
      loc: [result.lat, result.lon],
    })),
    ...sampleDataResults.map((result) => ({
      display_name: result.title,
      loc: result.loc,
    })),
  ];

  callResponse(combinedResults);
}

// 更新搜索控件，使用新的搜索方法
var searchControl = L.control.search({
  sourceData: function (text, callResponse) {
    searchNominatim(text).then((results) => {
      callResponse(results);
    });
  },
  propertyName: 'display_name',
  propertyLoc: ['lat', 'lon'],
  marker: L.circleMarker([0, 0], { radius: 30 }),
  autoCollapse: true,
  autoType: false,
  minLength: 2,
  filterData: function (text, records) {
    var newText = String(text);
    var regSearch = new RegExp(newText.replace(/[.?*+^$[\]\\(){}|-]/g, '\\$&'), 'i');
    return records.filter(function (elem) {
      return regSearch.test(elem.display_name);
    });
  },
}).addTo(mapAdd);


// 其他代码与原代码相同


    /*
    * Geolocation on the map
    */

 

    $('#locate-me').click(function() {
        mapAdd.locate({setView: true});
    });

    /*
    * Update links under the map
    */
    $('.note > a#reportmap-fullscreen').click(function() {
        $( this ).attr('href', '/reportmap.html' + window.location.hash);
    });

/*
    * Tweet link
    */
    $('.tweet-link').click(function() {
         var twitterBaselink = "https://twitter.com/intent/tweet?";
         var params = {
            url: window.location.href,
            via: 'OpenStreeMapIt',
            text: "L'agenzia delle entrate copia da OpenStreetMap! #agenziauscite"
        };

        $( this ).attr('href', twitterBaselink + $.param(params));
    });


	var map = new L.Map('map', {zoom: 9, center: new L.latLng(data[0].loc) });	//set center from first location


     // 添加 OpenStreetMap 图层
     L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

	  var markersLayer = new L.LayerGroup();	//layer contain searched elements
	map.addLayer(markersLayer);



	////////////populate map with markers from sample data
	for(i in data) {
		var title = data[i].title,	//value searched
			loc = data[i].loc,		//position found
			marker = new L.Marker(new L.latLng(loc), {title: title} );//se property searched
		marker.bindPopup('title: '+ title );
		markersLayer.addLayer(marker);
	}

	map.addControl( new L.Control.Search({
		container: 'findbox',
		layer: markersLayer,
		initial: false,
		collapsed: false,
		textPlaceholder: 'search for a movie ',
		textErr: 'Sorry, no results found.',
	
	}) );
      </script>


</body>
</html>
